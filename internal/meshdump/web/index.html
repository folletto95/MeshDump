<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>MeshDump</title>
    <script src="lib/chart.umd.min.js"></script>
    <script src="lib/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #container { display: flex; align-items: flex-start; }
        #sidebar { margin-right: 20px; }
        #nodeSelect { min-width: 200px; padding: 4px; font-size: 14px; }
        #nodeList { list-style: none; padding-left: 0; margin-top: 10px; }
        .has-data { font-weight: bold; }
    </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <label for="nodeSelect">Select node:</label><br/>
    <select id="nodeSelect"></select>
    <br/>
    <label for="dataTypeSelect">Data type:</label><br/>
    <select id="dataTypeSelect"></select>
    <ul id="nodeList"></ul>
  </div>
  <div id="main">
    <h1>MeshDump Telemetry</h1>
    <pre id="nodeInfo" style="background:#f4f4f4;padding:10px;border:1px solid #ccc;overflow:auto"></pre>
    <canvas id="chart" width="600" height="400"></canvas>
    </div>
  </div>
<script>
async function fetchNodes() {
    return fetch('/api/nodes').then(r => r.json());
}
async function fetchNodeInfo(id) {
    return fetch('/api/nodeinfo/' + id).then(r => r.json());
}
async function fetchTelemetry(node) {
    return fetch('/api/telemetry/' + node).then(r => r.json());
}
let chart;
function ensureChart(datasets) {
    const ctx = document.getElementById('chart');
    const data = datasets.length ? datasets : [{label: '', data: []}];
    if (!chart) {
        chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: data },
            options: { scales: { x: { type: 'time' }, y: {} } }
        });
    } else {
        chart.data.datasets = data;
        chart.update();
    }
}
async function updateNodes() {
    const nodes = await fetchNodes();
    const select = document.getElementById('nodeSelect');
    const list = document.getElementById('nodeList');
    const current = select.value;
    select.innerHTML = '';
    list.innerHTML = '';
    select.size = nodes.length || 1;
    for (const n of nodes) {
        const name = n.long_name || n.short_name || n.id;
        const opt = document.createElement('option');
        opt.value = n.id;
        opt.textContent = name;
        if (n.has_data) opt.classList.add('has-data');
        select.appendChild(opt);
        const li = document.createElement('li');
        li.textContent = name;
        if (n.has_data) li.classList.add('has-data');
        list.appendChild(li);
    }
    if (current) {
        select.value = current;
    }
    return nodes;
}
async function refresh() {
    const node = document.getElementById('nodeSelect').value;
    if (!node) return;
    const info = await fetchNodeInfo(node);
    const infoText = [`ID: ${info.id}`];
    if (info.long_name) infoText.push(`Long name: ${info.long_name}`);
    if (info.short_name) infoText.push(`Short name: ${info.short_name}`);
    if (info.firmware) infoText.push(`Firmware: ${info.firmware}`);
    document.getElementById('nodeInfo').textContent = infoText.join('\n');
    const data = await fetchTelemetry(node);
    const groups = {};
    for (const t of data) {
        if (!groups[t.DataType]) groups[t.DataType] = [];
        groups[t.DataType].push({x: new Date(t.Timestamp), y: t.Value});
    }
    const typeSelect = document.getElementById('dataTypeSelect');
    const currentType = typeSelect.value;
    const types = Object.keys(groups).sort();
    typeSelect.innerHTML = '';
    for (const t of types) {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        typeSelect.appendChild(opt);
    }
    if (currentType && types.includes(currentType)) {
        typeSelect.value = currentType;
    } else if (types.includes('voltage')) {
        typeSelect.value = 'voltage';
    }
    const selectedType = typeSelect.value;
    const datasets = [];
    if (selectedType && groups[selectedType]) {
        datasets.push({
            label: selectedType,
            data: groups[selectedType],
            borderColor: 'hsl(200,70%,50%)',
            fill: false,
        });
    }
    ensureChart(datasets);
}
async function init() {
    const select = document.getElementById('nodeSelect');
    const typeSelect = document.getElementById('dataTypeSelect');
    select.addEventListener('change', refresh);
    typeSelect.addEventListener('change', refresh);
    const nodes = await updateNodes();
    if (nodes.length) {
        select.value = nodes[0].id;
        refresh();
        setInterval(refresh, 30000);
    }
    setInterval(updateNodes, 5000);
}
init();
</script>
</body>
</html>
