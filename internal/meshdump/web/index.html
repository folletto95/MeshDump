<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>MeshDump</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #nodeSelect { min-width: 200px; padding: 4px; font-size: 14px; }
    </style>
</head>
<body>
<h1>MeshDump Telemetry</h1>
<label for="nodeSelect">Select node:</label>
<select id="nodeSelect"></select>
<div id="nodeInfo"></div>
<canvas id="chart" width="600" height="400"></canvas>
<script>
async function fetchNodes() {
    return fetch('/api/nodes').then(r => r.json());
}
async function fetchNodeInfo(id) {
    return fetch('/api/nodeinfo/' + id).then(r => r.json());
}
async function fetchTelemetry(node) {
    return fetch('/api/telemetry/' + node).then(r => r.json());
}
let chart;
async function refresh() {
    const node = document.getElementById('nodeSelect').value;
    if (!node) return;
    const info = await fetchNodeInfo(node);
    document.getElementById('nodeInfo').textContent = info.Firmware ? `Firmware: ${info.Firmware}` : '';
    const data = await fetchTelemetry(node);
    const groups = {};
    for (const t of data) {
        if (!groups[t.DataType]) groups[t.DataType] = [];
        groups[t.DataType].push({x: new Date(t.Timestamp), y: t.Value});
    }
    const datasets = Object.entries(groups).map(([type, vals], i) => ({
        label: type,
        data: vals,
        borderColor: `hsl(${i*60},70%,50%)`,
        fill: false,
    }));
    if (!chart) {
        chart = new Chart(document.getElementById('chart'), {
            type: 'line',
            data: { datasets },
            options: { scales: { x: { type: 'time' } } }
        });
    } else {
        chart.data.datasets = datasets;
        chart.update();
    }
}
async function init() {
    const select = document.getElementById('nodeSelect');
    const nodes = await fetchNodes();
    for (const n of nodes) {
        const opt = document.createElement('option');
        opt.value = n.ID;
        opt.textContent = n.LongName || n.ShortName || n.ID;
        select.appendChild(opt);
    }
    select.addEventListener('change', refresh);
    if (nodes.length) {
        select.value = nodes[0].ID;
        refresh();
        setInterval(refresh, 30000);
    }
}
init();
</script>
</body>
</html>
