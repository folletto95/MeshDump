<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>MeshDump</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #container { display: flex; align-items: flex-start; }
        #sidebar { margin-right: 20px; }
        #nodeSelect { min-width: 200px; padding: 4px; font-size: 14px; }
        #nodeList { list-style: none; padding-left: 0; margin-top: 10px; }
    </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <label for="nodeSelect">Select node:</label><br/>
    <select id="nodeSelect"></select>
    <ul id="nodeList"></ul>
  </div>
  <div id="main">
    <h1>MeshDump Telemetry</h1>
    <div id="nodeInfo"></div>
    <canvas id="chart" width="600" height="400"></canvas>
  </div>
</div>
<script>
async function fetchNodes() {
    return fetch('/api/nodes').then(r => r.json());
}
async function fetchNodeInfo(id) {
    return fetch('/api/nodeinfo/' + id).then(r => r.json());
}
async function fetchTelemetry(node) {
    return fetch('/api/telemetry/' + node).then(r => r.json());
}
let chart;
async function updateNodes() {
    const nodes = await fetchNodes();
    const select = document.getElementById('nodeSelect');
    const list = document.getElementById('nodeList');
    const current = select.value;
    select.innerHTML = '';
    list.innerHTML = '';
    for (const n of nodes) {
        const name = n.long_name || n.short_name || n.id;
        const opt = document.createElement('option');
        opt.value = n.id;
        opt.textContent = name;
        select.appendChild(opt);
        const li = document.createElement('li');
        li.textContent = name;
        list.appendChild(li);
    }
    if (current) {
        select.value = current;
    }
    return nodes;
}
async function refresh() {
    const node = document.getElementById('nodeSelect').value;
    if (!node) return;
    const info = await fetchNodeInfo(node);
    document.getElementById('nodeInfo').textContent = info.firmware ? `Firmware: ${info.firmware}` : '';
    const data = await fetchTelemetry(node);
    const groups = {};
    for (const t of data) {
        if (!groups[t.DataType]) groups[t.DataType] = [];
        groups[t.DataType].push({x: new Date(t.Timestamp), y: t.Value});
    }
    const datasets = Object.entries(groups).map(([type, vals], i) => ({
        label: type,
        data: vals,
        borderColor: `hsl(${i*60},70%,50%)`,
        fill: false,
    }));
    if (!chart) {
        chart = new Chart(document.getElementById('chart'), {
            type: 'line',
            data: { datasets },
            options: { scales: { x: { type: 'time' } } }
        });
    } else {
        chart.data.datasets = datasets;
        chart.update();
    }
}
async function init() {
    const select = document.getElementById('nodeSelect');
    select.addEventListener('change', refresh);
    const nodes = await updateNodes();
    if (nodes.length) {
        select.value = nodes[0].id;
        refresh();
        setInterval(refresh, 30000);
    }
    setInterval(updateNodes, 5000);
}
init();
</script>
</body>
</html>
